name: Generate Xray Credentials
description: Generate UUIDs, short IDs, and Reality key pairs using dedicated utility containers
inputs: {}
runs:
  using: composite
  steps:
    - name: Generate UUID
      id: uuid
      uses: docker://docker.io/library/alpine:3.19
      with:
        entrypoint: /bin/sh
        args: /github/workspace/.github/actions/generate-credentials/scripts/uuid.sh

    - name: Generate short IDs
      id: short_ids
      uses: docker://docker.io/library/alpine:3.19
      with:
        entrypoint: /bin/sh
        args: /github/workspace/.github/actions/generate-credentials/scripts/short-ids.sh

    - name: Generate Xray key pair
      id: xray_keys
      uses: docker://ghcr.io/xtls/xray-core:latest
      with:
        entrypoint: /bin/sh
        args: /github/workspace/.github/actions/generate-credentials/scripts/xray-keys.sh

    - name: Publish credentials
      shell: sh
      env:
        UUID: ${{ steps.uuid.outputs.value }}
        SHORT_IDS: ${{ steps.short_ids.outputs.value }}
        PRIVATE_KEY: ${{ steps.xray_keys.outputs.private }}
        PUBLIC_KEY: ${{ steps.xray_keys.outputs.public }}
      run: |
        set -eu

        OUTPUT_DIR="${RUNNER_TEMP:-/tmp}"
        mkdir -p "$OUTPUT_DIR"
        OUTPUT_FILE="$OUTPUT_DIR/xray-credentials.txt"

        set -- $SHORT_IDS
        {
          echo "XRAY_UUID: $UUID"
          echo "XRAY_SHORT_IDS:"
          for short_id in "$@"; do
            echo "  - $short_id"
          done
          echo "XRAY_PRIVATE_KEY: $PRIVATE_KEY"
          echo "XRAY_PUBLIC_KEY: $PUBLIC_KEY"
        } >"$OUTPUT_FILE"

        echo "::group::Xray Reality Credentials"
        cat "$OUTPUT_FILE"
        echo "::endgroup::"

        set -- $SHORT_IDS
        {
          echo "### Generated Xray Credentials"
          echo
          echo "- **UUID:** \`$UUID\`"
          echo "- **Short IDs:**"
          for short_id in "$@"; do
            echo "  - \`$short_id\`"
          done
          echo "- **Reality Private Key:** \`$PRIVATE_KEY\`"
          echo "- **Reality Public Key:** \`$PUBLIC_KEY\`"
          echo
          echo "> Copy the values above into your inventory or secret manager."
        } >>"$GITHUB_STEP_SUMMARY"
